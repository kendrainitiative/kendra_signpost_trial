<?php

include_once('kendra_cat.features.inc');

function kendra_cat_add_node($headers, $data) {
  // Default node -> csv heading mappings
  $mappings = array(
    'title' => array('Track', 'Title', 'Name', 'track_name'),
    'field_cat_artist' => array('Artist', 'track_artist'),
    'field_cat_label' => array('Label'),
    'field_cat_no' => array('Catalogue Number', 'CAE Number', 'release_id'),
    'field_cat_date' => array('Release Date', 'Year', 'release_date'),
    'field_cat_album' => array('Album/ep title', 'Album', 'Album', 'album_title'),
    'field_cat_publisher' => array('Publisher', 'publisher'),
    'field_cat_isrc' => array('ISRC Code', 'isrc_code'),
  );
  
  // drupal_set_message(print_r($data, TRUE));
  global $user;
  $node = new stdClass();
  $node->uid = $user->uid;
  $node->type = 'kendra_cat';

  foreach ($mappings as $field => $names) {
    foreach ($names as $name) {
      $pos = array_search($name, $headers);
      if ($pos !== FALSE) {
        // titles are not field values:
        if ($field == 'title') {
          $node->$field = $data[$pos];
        } else {
          $node->$field = array(array('value' => $data[$pos]));
        }
      }
    }
  }
  $node->field_cat_rowuri[0]['value'] = url("node/{$data['source_nid']}", array('absolute' => TRUE)) 
    ."/rows#{$data['source_row']}";
  node_save($node);  
}

/*
 * Make rowuri available to solr
 */
function kendra_cat_apachesolr_cck_fields_alter(&$mappings) {
  $mappings['text']['text_textfield'] = array(
    'callback' => 'kendra_cat_textfield_callback',
    'index_type' => 'string',
    // This callback seems to keep changing. Here some code 
    // in prepration for changes in apachesolr.module v2
    'indexing_callback' => 'kendra_cat_textfield_callback',
    'display_callback' => 'kendra_cat_textfield_display_callback',
  );
  //watchdog('kendra_cat_mappings', 'mappings: '. print_r($mappings, TRUE));
}

/**
* A function that gets called during indexing.
* @node The current node being indexed
* @fieldname The current field being indexed
*
* @return an array of arrays. Each inner array is a value, and must be
* keyed 'safe' => $value
*
function kendra_cat_textfield_callback($node, $fieldname) {
  $fields = array();
  foreach ($node->$fieldname as $field) {
    $fields[] = array('safe' => check_plain($field['value']));
  }
  return $fields;
}
*/
function kendra_cat_textfield_callback($node, $field_name, $cck_info = '') {
  // $fields is an array because we send back a key => value pair for every
  // value of the field.
  $fields = array();
  // Don't do anything if this node doesn't have this field.
  if (isset($node->$field_name)) {
    // Get the index key based on the $cck_info.
    $index_key = apachesolr_index_key($cck_info);
    foreach ($node->$field_name as $field) {
      // For every field, add a key => value pair to the $fields array.
      $fields[] = array(
        'key' => $index_key,
        'value' => check_plain($field['value']),
      );
    }
  }
  //watchdog('kendra_cat_field', 'indexing field: '. print_r($fields, TRUE));
  return $fields;
}

/**
* Determines what to display in facet links for this field.
*
* @param $facet
*   The raw value (from the index) of this facet field. This corresponds to
*   'value' from the indexing callback.
* @param $options
*   CCK info. In this example it will be an array with a "delta" key with either a
*   "filefile" or "imagefield" value. Here we ignore it and just return the $facet.
*/
function kendra_cat_textfield_display_callback($facet, $options) {
  return $facet;
}









