<?php

include_once('kendra_cat.features.inc');

function kendra_cat_add_node($headers, $data) {
  // Default node -> csv heading mappings
  $mappings = array(
    'title' => array('Track', 'Title', 'Name'),
    'field_cat_artist' => array('Artist'),
    'field_cat_label' => array('Label'),
    'field_cat_no' => array('Catalogue Number', 'CAE Number'),
    'field_cat_date' => array('Release Date', 'Year'),
    'field_cat_album' => array('Album/ep title', 'Album', 'Album'),
    'field_cat_publisher' => array('Publisher'),
    'field_cat_isrc' => array('ISRC Code'),
  );
  
  // drupal_set_message(print_r($data, TRUE));
  global $user;
  $node = new stdClass();
  $node->uid = $user->uid;
  $node->type = 'kendra_cat';

  foreach ($mappings as $field => $names) {
    foreach ($names as $name) {
      $pos = array_search($name, $headers);
      if ($pos !== FALSE) {
        // titles are not field values:
        if ($field == 'title') {
          $node->$field = $data[$pos];
        } else {
          $node->$field = array(array('value' => $data[$pos]));
        }
      }
    }
  }
  $node->field_cat_rowuri[0]['value'] = url("node/{$data['source_nid']}", array('absolute' => TRUE)) 
    ."/rows#{$data['source_row']}";
  node_save($node);  
}

/*
 * Make rowuri available to solr
 */
function kendra_cat_apachesolr_cck_field_mappings() {
  $mappings = array();
  // 'text' is the CCK field_type. Correlates to $field['field_type']
  $mappings['text'] = array(
    // The callback function gets called at indexing time to get the values.
    'callback' => 'kendra_cat_textfield_callback',
    // Common types are 'text', 'string', 'integer', 'double', 'float', 'date', 'boolean'
    'index_type' => 'string',
    // These are the CCK formatting widgets for which this mapping applies.
    // If we wanted to target images but not generic files, for example,
    // we could say 'filefield_widget' => FALSE
    'widget_types' => array('text_textfield' => TRUE, 'text_textarea' => FALSE),
  );
  return $mappings;
}

/**
* A function that gets called during indexing.
* @node The current node being indexed
* @fieldname The current field being indexed
*
* @return an array of arrays. Each inner array is a value, and must be
* keyed 'safe' => $value
*/
function kendra_cat_textfield_callback($node, $fieldname) {
  $fields = array();
  foreach ($node->$fieldname as $field) {
    $fields[] = array('safe' => check_plain($field['value']));
  }
  return $fields;
}











